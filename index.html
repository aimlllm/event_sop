<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Hosting SOP - Interactive Tree</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-primary: #0a0e1a;
        --bg-secondary: #111827;
        --bg-tertiary: #1f2937;
        --bg-card: #374151;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --text-muted: #9ca3af;
        --accent-primary: #6366f1;
        --accent-secondary: #8b5cf6;
        --accent-success: #10b981;
        --accent-warning: #f59e0b;
        --accent-danger: #ef4444;
        --border-primary: #4b5563;
        --border-secondary: #6b7280;
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 100%);
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .header-container {
        background: rgba(17, 24, 39, 0.8);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-primary);
        padding: 1.5rem 0;
        margin-bottom: 2rem;
      }

      .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }

      .logo-icon {
        width: 2.5rem;
        height: 2.5rem;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-lg);
      }

      .logo-text {
        font-size: 2rem;
        font-weight: 800;
        color: #6366f1;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.025em;
      }

      /* Fallback for browsers that don't support background-clip: text */
      @supports not (-webkit-background-clip: text) {
        .logo-text {
          color: #6366f1 !important;
          background: none !important;
        }
      }

      .subtitle {
        text-align: center;
        color: var(--text-muted);
        font-size: 1rem;
        font-weight: 500;
      }

      .tree-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 1rem;
      }

      .tree-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 1.5rem;
        box-shadow: var(--shadow-xl);
        position: relative;
        overflow: hidden;
      }

      .node-card {
        filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
      }

      .node-card:hover {
        filter: drop-shadow(0 8px 25px rgba(99, 102, 241, 0.3));
        transform: translateY(-2px);
      }

      .node.selected .node-card {
        filter: drop-shadow(0 12px 35px rgba(99, 102, 241, 0.5));
        transform: translateY(-3px);
      }

      .node.done .node-card {
        background: var(--accent-success) !important;
        border-color: var(--accent-success) !important;
      }

      .node.done text {
        fill: white !important;
      }

      .sidebar {
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        box-shadow: var(--shadow-xl);
      }

      @keyframes slideIn {
        from { 
          transform: translateX(100%);
          opacity: 0;
        }
        to { 
          transform: translateX(0);
          opacity: 1;
        }
      }

      .custom-checkbox {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
      }

      .custom-checkbox input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
      }

      .checkmark {
        height: 1.25rem;
        width: 1.25rem;
        background: var(--bg-tertiary);
        border: 2px solid var(--border-secondary);
        border-radius: 0.375rem;
        position: relative;
        transition: all 0.2s ease;
      }

      .custom-checkbox:hover .checkmark {
        border-color: var(--accent-primary);
      }

      .custom-checkbox input:checked ~ .checkmark {
        background: var(--accent-success);
        border-color: var(--accent-success);
      }

      .checkmark:after {
        content: "";
        position: absolute;
        display: none;
        left: 0.25rem;
        top: 0.125rem;
        width: 0.25rem;
        height: 0.5rem;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

      .custom-checkbox input:checked ~ .checkmark:after {
        display: block;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        text-decoration: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: white;
        box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.4);
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
      }

      .btn-secondary:hover {
        background: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-secondary);
      }

      .btn-danger {
        background: var(--accent-danger);
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .input-field {
        width: 100%;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        outline: none;
      }

      .input-field:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .input-field::placeholder {
        color: var(--text-muted);
      }

      .section-title {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
      }

      .fade-bg {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(2px);
      }

      .link-path {
        stroke: var(--border-primary);
        stroke-width: 2;
        fill: none;
        opacity: 0.6;
        transition: all 0.3s ease;
      }

      .link-path:hover {
        stroke: var(--accent-primary);
        opacity: 0.8;
      }

      .node-text {
        pointer-events: none;
        user-select: none;
      }

      @media (max-width: 768px) {
        .tree-container {
          width: 95vw !important;
          height: 500px !important;
        }
        
        .sidebar {
          width: 95vw !important;
          height: 85vh !important;
          top: 7.5vh !important;
          right: 2.5vw !important;
          left: 2.5vw !important;
          border-radius: 1rem !important;
        }
        
        .logo-text {
          font-size: 1.5rem;
        }
      }

      /* Zoom Controls Styling */
      .zoom-controls {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .zoom-btn {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        font-size: 16px;
        font-weight: 600;
      }

      .zoom-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        border-color: var(--accent-primary);
      }

      .zoom-btn:active {
        transform: translateY(0);
        transition-duration: 0.1s;
      }

      /* Enhanced Mobile Responsive Design */
      @media (max-width: 480px) {
        .tree-container {
          width: 98vw !important;
          height: 60vh !important;
          margin: 0.5rem auto;
          border-radius: 1rem !important;
        }

        .header-container {
          padding: 1rem 0;
          margin-bottom: 1rem;
        }

        .logo-text {
          font-size: 1.25rem;
        }

        .subtitle {
          font-size: 0.875rem;
        }

        .zoom-controls {
          top: 5px !important;
          right: 5px !important;
          gap: 6px !important;
        }

        .zoom-btn {
          width: 35px !important;
          height: 35px !important;
          font-size: 14px !important;
        }

        .sidebar {
          width: 98vw !important;
          height: 90vh !important;
          top: 5vh !important;
          right: 1vw !important;
          left: 1vw !important;
          border-radius: 0.75rem !important;
        }
      }

      /* Tablet Responsive Design */
      @media (min-width: 769px) and (max-width: 1023px) {
        .tree-container {
          width: 90vw !important;
          height: 70vh !important;
          max-width: 900px;
        }

        .zoom-controls {
          top: 8px !important;
          right: 8px !important;
        }

        .sidebar {
          width: 85vw !important;
          max-width: 600px;
          height: 80vh !important;
          top: 10vh !important;
          right: 7.5vw !important;
          left: 7.5vw !important;
        }
      }

      /* Touch-friendly interactions */
      @media (hover: none) and (pointer: coarse) {
        .node-card:hover {
          transform: none;
          filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
        }

        .btn:hover {
          transform: none;
        }

        .zoom-btn:hover {
          transform: none;
          box-shadow: var(--shadow-lg);
        }

        /* Larger touch targets */
        .node-card {
          min-height: 50px;
        }

        .zoom-btn {
          min-width: 44px !important;
          min-height: 44px !important;
        }
      }

      /* High DPI displays */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .node-text {
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
      }

      /* Landscape orientation on mobile */
      @media (max-width: 768px) and (orientation: landscape) {
        .tree-container {
          height: 80vh !important;
        }

        .header-container {
          padding: 0.75rem 0;
          margin-bottom: 0.75rem;
        }

        .sidebar {
          height: 95vh !important;
          top: 2.5vh !important;
        }
      }

      /* Accessibility improvements */
      .zoom-btn:focus {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
      }

      .node-card:focus {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
      }

      /* Reduce motion for accessibility */
      @media (prefers-reduced-motion: reduce) {
        .node-card,
        .zoom-btn,
        .btn,
        .sidebar {
          transition: none;
        }

        .sidebar {
          animation: none;
        }
      }

      /* Enhanced hierarchical coloring for parent-child relationships */
      .node.depth-0 .node-card {
        background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
        border-color: #6366f1 !important;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4) !important;
      }

      .node.depth-1 .node-card {
        background: linear-gradient(135deg, #3b82f6, #06b6d4) !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3) !important;
      }

      .node.depth-2 .node-card {
        background: linear-gradient(135deg, #10b981, #34d399) !important;
        border-color: #10b981 !important;
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3) !important;
      }

      .node.depth-3 .node-card {
        background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
        border-color: #f59e0b !important;
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3) !important;
      }

      .node.depth-4 .node-card {
        background: linear-gradient(135deg, #ef4444, #f87171) !important;
        border-color: #ef4444 !important;
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3) !important;
      }

      /* Enhanced hover effects with depth awareness */
      .node.depth-0:hover .node-card {
        filter: drop-shadow(0 8px 30px rgba(99, 102, 241, 0.6));
        transform: translateY(-3px) scale(1.02);
      }

      .node.depth-1:hover .node-card {
        filter: drop-shadow(0 8px 30px rgba(59, 130, 246, 0.5));
        transform: translateY(-3px) scale(1.02);
      }

      .node.depth-2:hover .node-card {
        filter: drop-shadow(0 8px 30px rgba(16, 185, 129, 0.5));
        transform: translateY(-3px) scale(1.02);
      }

      .node.depth-3:hover .node-card {
        filter: drop-shadow(0 8px 30px rgba(245, 158, 11, 0.5));
        transform: translateY(-3px) scale(1.02);
      }

      .node.depth-4:hover .node-card {
        filter: drop-shadow(0 8px 30px rgba(239, 68, 68, 0.5));
        transform: translateY(-3px) scale(1.02);
      }

      /* Hierarchical link coloring */
      .link-depth-0 {
        stroke: #6366f1 !important;
        stroke-width: 3px !important;
        opacity: 0.8 !important;
      }

      .link-depth-1 {
        stroke: #3b82f6 !important;
        stroke-width: 2.5px !important;
        opacity: 0.7 !important;
      }

      .link-depth-2 {
        stroke: #10b981 !important;
        stroke-width: 2px !important;
        opacity: 0.6 !important;
      }

      .link-depth-3 {
        stroke: #f59e0b !important;
        stroke-width: 2px !important;
        opacity: 0.6 !important;
      }

      .link-depth-4 {
        stroke: #ef4444 !important;
        stroke-width: 2px !important;
        opacity: 0.6 !important;
      }

      /* Status override colors - these take precedence when tasks are completed/in-progress */
      .node.done .node-card {
        background: linear-gradient(135deg, #10b981, #34d399) !important;
        border-color: #10b981 !important;
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.5) !important;
      }

      .node.in-progress .node-card {
        background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
        border-color: #f59e0b !important;
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4) !important;
      }

      /* Enhanced selection highlighting */
      .node.selected .node-card {
        filter: drop-shadow(0 12px 40px rgba(99, 102, 241, 0.7)) !important;
        transform: translateY(-4px) scale(1.05) !important;
        border: 2px solid #ffffff !important;
      }

      /* Collapse/expand indicator styling */
      .node.has-children .node-card {
        border-left: 4px solid rgba(255, 255, 255, 0.3);
        position: relative;
      }

      .node.collapsed .node-card {
        border-left: 4px solid rgba(255, 255, 255, 0.6);
        opacity: 0.9;
      }

      .node.collapsed .node-card::after {
        content: '+';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-weight: bold;
        font-size: 16px;
        pointer-events: none;
      }

      .node.expanded .node-card::after {
        content: '−';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-weight: bold;
        font-size: 16px;
        pointer-events: none;
      }

      /* Color Legend Responsive Styling */
      .color-legend {
        transition: transform 0.3s ease;
      }

      .color-legend:hover {
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .color-legend {
          top: 60px !important;
          left: 10px !important;
          max-width: 200px !important;
          font-size: 11px !important;
        }

        .color-legend h3 {
          font-size: 12px !important;
          margin-bottom: 8px !important;
        }

        .color-legend .space-y-2 {
          gap: 4px !important;
        }

        .color-legend .w-4 {
          width: 12px !important;
          height: 12px !important;
        }
      }

      @media (max-width: 480px) {
        .color-legend {
          top: 50px !important;
          left: 5px !important;
          right: 5px !important;
          max-width: none !important;
          padding: 12px !important;
        }
      }
    </style>
</head>
<body>
  <div class="header-container">
    <div class="logo-container">
      <div class="logo-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
          <circle cx="12" cy="12" r="10"/>
          <path d="M8 12l2 2 4-4"/>
        </svg>
      </div>
      <h1 class="logo-text">Event Hosting SOP</h1>
    </div>
    <p class="subtitle">Professional event planning workflow management</p>
  </div>

  <div class="tree-wrapper">
    <div id="tree-container" class="tree-container" style="width: 1100px; height: 800px;">
    </div>
    
    <!-- Hierarchical Color Legend -->
    <div class="color-legend fixed top-4 left-4 z-40 bg-gray-800/90 backdrop-blur-sm border border-gray-600 rounded-xl p-4 max-w-xs">
      <h3 class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M8 12l2 2 4-4"/>
        </svg>
        Hierarchy Colors
      </h3>
      <div class="space-y-2 text-xs">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded bg-gradient-to-r from-indigo-500 to-purple-600"></div>
          <span class="text-gray-200">Root Level</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded bg-gradient-to-r from-blue-500 to-cyan-500"></div>
          <span class="text-gray-200">Main Categories</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded bg-gradient-to-r from-green-500 to-emerald-400"></div>
          <span class="text-gray-200">Sub-tasks</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded bg-gradient-to-r from-yellow-500 to-yellow-400"></div>
          <span class="text-gray-200">Detail Items</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded bg-gradient-to-r from-red-500 to-red-400"></div>
          <span class="text-gray-200">Nested Items</span>
        </div>
        <div class="border-t border-gray-600 pt-2 mt-3">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-green-500"></div>
            <span class="text-gray-200">Completed</span>
          </div>
          <div class="flex items-center gap-2 mt-1">
            <div class="w-4 h-4 rounded bg-yellow-500"></div>
            <span class="text-gray-200">In Progress</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="fade-bg" class="fade-bg fixed inset-0 z-40 hidden"></div>
  
  <div id="sidebar" class="sidebar fixed top-4 right-4 z-50 h-[92vh] w-[450px] max-w-[95vw] rounded-2xl p-6 hidden flex-col overflow-y-auto">
    <div id="sidebar-content"></div>
  </div>

<script>
// --------- SOP DATA ---------
const sopData = {
    "name": "Event Hosting SOP",
    "children": [
        {
            "name": "Event Planning (4-6 weeks before)",
            "children": [
                { 
                    "name": "Event Concept & Goals", 
                    "description": "Define event purpose, objectives, and success metrics", 
                    "materials": "Goals worksheet, KPI tracking sheet", 
                    "role": "", 
                    "timeline": "6 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Date & Time Selection", 
                    "description": "Choose optimal date and time considering target audience availability", 
                    "materials": "Calendar analysis, timezone research, competitor events check", 
                    "role": "", 
                    "timeline": "6 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Venue/Platform Selection", 
                    "description": "Select venue for in-person or platform for virtual/hybrid events", 
                    "materials": "Venue contracts, platform subscriptions, capacity requirements", 
                    "role": "", 
                    "timeline": "5-6 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Budget Planning", 
                    "description": "Create detailed budget including all costs and contingency", 
                    "materials": "Budget template, cost estimates, approval forms", 
                    "role": "", 
                    "timeline": "5 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Speaker/Guest Identification", 
                    "description": "Research and create list of potential keynote speakers and panelists", 
                    "materials": "Speaker database, biography templates, contact information", 
                    "role": "", 
                    "timeline": "5 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Initial Speaker Outreach", 
                    "description": "Send initial invitations to speakers with event details", 
                    "materials": "Speaker invitation templates, event brief, fee structure", 
                    "role": "", 
                    "timeline": "4-5 weeks before",
                    "status": "not-started"
                }
            ]
        },
        {
            "name": "Marketing & Promotion (3-4 weeks before)",
            "children": [
                { 
                    "name": "Event Branding & Design", 
                    "description": "Create visual identity, logo, and design assets for the event", 
                    "materials": "Brand guidelines, design software, asset library", 
                    "role": "", 
                    "timeline": "4 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Registration Platform Setup", 
                    "description": "Configure registration system with forms, payment processing, and confirmation emails", 
                    "materials": "Platform subscription, payment gateway, form templates", 
                    "role": "", 
                    "timeline": "3-4 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Landing Page Creation", 
                    "description": "Build event website/landing page with all essential information", 
                    "materials": "Web hosting, content copy, images, registration integration", 
                    "role": "", 
                    "timeline": "3 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Content Creation", 
                    "description": "Develop promotional content for various channels", 
                    "materials": "Content calendar, copywriting templates, visual assets", 
                    "role": "", 
                    "timeline": "3 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Email Campaign Setup", 
                    "description": "Create email sequences for promotion and follow-ups", 
                    "materials": "Email templates, segmentation lists, automation rules", 
                    "role": "", 
                    "timeline": "3 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Social Media Campaign Launch", 
                    "description": "Begin promoting across LinkedIn, Twitter, Instagram, Facebook", 
                    "materials": "Social media accounts, content calendar, scheduling tools", 
                    "role": "", 
                    "timeline": "3 weeks before",
                    "status": "not-started"
                }
            ]
        },
        {
            "name": "Email Notifications & Communications",
            "children": [
                {
                    "name": "Initial Promotion Email",
                    "description": "Send first announcement email to mailing list and potential attendees",
                    "materials": "Email template, recipient list, event details, registration link",
                    "role": "",
                    "timeline": "3 weeks before event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Join us for [Event Name] - Registration Now Open!",
                        "content": "Event announcement with key details, speakers, agenda highlights, and registration CTA",
                        "audience": "Full mailing list, past attendees, target audience segments"
                    }
                },
                {
                    "name": "First Follow-up Email",
                    "description": "Send reminder email with additional event details and early bird offers",
                    "materials": "Follow-up template, updated agenda, special offers",
                    "role": "",
                    "timeline": "2 weeks before event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Don't Miss Out: [Event Name] - Early Bird Pricing Ends Soon",
                        "content": "Reminder with agenda details, speaker bios, early bird deadline, social proof",
                        "audience": "Non-registered contacts, partially engaged prospects"
                    }
                },
                {
                    "name": "Final Registration Reminder",
                    "description": "Last chance email for registration before cutoff",
                    "materials": "Urgency-focused template, final agenda, testimonials",
                    "role": "",
                    "timeline": "1 week before event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Last Chance: Register for [Event Name] - Closing Soon!",
                        "content": "Final registration call with urgency, limited spots, full agenda",
                        "audience": "Non-registered warm prospects, newsletter subscribers"
                    }
                },
                {
                    "name": "Pre-Event Details Email",
                    "description": "Send comprehensive event details to registered attendees",
                    "materials": "Event guide template, logistical details, preparation materials",
                    "role": "",
                    "timeline": "2-3 days before event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "You're All Set for [Event Name] - Important Event Details Inside",
                        "content": "Complete event guide: agenda, speaker info, venue/platform details, what to expect",
                        "audience": "Confirmed registered attendees only"
                    }
                },
                {
                    "name": "Day-Before Reminder",
                    "description": "Final reminder email with last-minute details and preparation tips",
                    "materials": "Reminder template, technical requirements, contact information",
                    "role": "",
                    "timeline": "1 day before event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Tomorrow is the Day! Final Reminders for [Event Name]",
                        "content": "Final reminder with time, tech check info, what to bring, contact details",
                        "audience": "All registered attendees"
                    }
                },
                {
                    "name": "Event Day Morning Email",
                    "description": "Morning-of email with final logistics and last-minute updates",
                    "materials": "Day-of template, any last-minute changes, technical support info",
                    "role": "",
                    "timeline": "Morning of event (2-3 hours before)",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Today's the Day! [Event Name] Starts in [X] Hours",
                        "content": "Final logistics, parking/platform info, emergency contacts, excitement building",
                        "audience": "All registered attendees"
                    }
                },
                {
                    "name": "1-Hour Before Alert",
                    "description": "Send urgent reminder 1 hour before event start",
                    "materials": "Alert template, direct access links, support contact",
                    "role": "",
                    "timeline": "1 hour before event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Starting in 1 Hour: [Event Name] - Join Now!",
                        "content": "Urgent reminder with direct access links, tech support, last-minute prep",
                        "audience": "All registered attendees"
                    }
                },
                {
                    "name": "Immediate Post-Event Thank You",
                    "description": "Send thank you email immediately after event ends",
                    "materials": "Thank you template, feedback survey link, next steps",
                    "role": "",
                    "timeline": "Within 2 hours after event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Thank You for Attending [Event Name]! Your Feedback Matters",
                        "content": "Gratitude message, feedback survey, resource links, upcoming events teaser",
                        "audience": "Event attendees (tracked)"
                    }
                },
                {
                    "name": "Resource Follow-up Email",
                    "description": "Send comprehensive follow-up with recordings, slides, and additional resources",
                    "materials": "Resource compilation, recording links, presentation slides, recommended reading",
                    "role": "",
                    "timeline": "1-2 days after event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "Your [Event Name] Resources Are Ready + Recording Available",
                        "content": "Event recording, presenter slides, additional resources, networking contacts",
                        "audience": "All registered attendees (both attended and no-shows)"
                    }
                },
                {
                    "name": "Long-term Follow-up",
                    "description": "Send follow-up email with impact metrics and future opportunities",
                    "materials": "Impact summary, case studies, upcoming events, community invites",
                    "role": "",
                    "timeline": "1 week after event",
                    "status": "not-started",
                    "emailDetails": {
                        "subject": "The Impact of [Event Name] + What's Next",
                        "content": "Event impact metrics, success stories, upcoming events, community joining options",
                        "audience": "All attendees and engaged prospects"
                    }
                }
            ]
        },
        {
            "name": "Speaker & Content Management (2-3 weeks before)",
            "children": [
                { 
                    "name": "Speaker Confirmation & Contracts", 
                    "description": "Finalize all speaker agreements and contracts", 
                    "materials": "Speaker contracts, payment terms, technical requirements", 
                    "role": "", 
                    "timeline": "3 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Content Collection", 
                    "description": "Collect presentations, bios, headshots, and technical requirements", 
                    "materials": "Content templates, asset collection forms, technical specs", 
                    "role": "", 
                    "timeline": "2 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Tech Rehearsals", 
                    "description": "Conduct technical rehearsals with all speakers", 
                    "materials": "Platform access, test scripts, technical checklist", 
                    "role": "", 
                    "timeline": "1 week before",
                    "status": "not-started"
                },
                { 
                    "name": "Final Content Review", 
                    "description": "Review all presentations and ensure brand compliance", 
                    "materials": "Brand guidelines, content review checklist, approval process", 
                    "role": "", 
                    "timeline": "3-5 days before",
                    "status": "not-started"
                }
            ]
        },
        {
            "name": "Pre-Event Logistics (1-2 weeks before)",
            "children": [
                { 
                    "name": "Registration List Management", 
                    "description": "Monitor and manage attendee registrations and communications", 
                    "materials": "Registration platform, attendee database, communication templates", 
                    "role": "", 
                    "timeline": "Ongoing until event",
                    "status": "not-started"
                },
                { 
                    "name": "Catering & Venue Setup Planning", 
                    "description": "Finalize catering orders and venue setup requirements", 
                    "materials": "Catering contracts, venue floor plans, setup schedules", 
                    "role": "", 
                    "timeline": "1-2 weeks before",
                    "status": "not-started"
                },
                { 
                    "name": "Technology Setup & Testing", 
                    "description": "Set up and test all technical equipment and platforms", 
                    "materials": "AV equipment, platform subscriptions, backup plans", 
                    "role": "", 
                    "timeline": "1 week before",
                    "status": "not-started"
                },
                { 
                    "name": "Staff Briefing & Role Assignment", 
                    "description": "Brief all team members on their roles and responsibilities", 
                    "materials": "Role descriptions, contact lists, emergency procedures", 
                    "role": "", 
                    "timeline": "2-3 days before",
                    "status": "not-started"
                },
                { 
                    "name": "Materials Preparation", 
                    "description": "Prepare name tags, welcome packets, signage, and giveaways", 
                    "materials": "Attendee lists, printing services, promotional materials", 
                    "role": "", 
                    "timeline": "2-3 days before",
                    "status": "not-started"
                }
            ]
        },
        {
            "name": "Event Day Execution",
            "children": [
                { 
                    "name": "Early Setup & Venue Preparation", 
                    "description": "Arrive early for complete venue setup and final checks", 
                    "materials": "Setup checklist, vendor contact list, emergency supplies", 
                    "role": "", 
                    "timeline": "2-3 hours before start",
                    "status": "not-started"
                },
                { 
                    "name": "Registration & Check-in Setup", 
                    "description": "Set up registration desk with materials and staff", 
                    "materials": "Check-in tablets, name tags, welcome packets, staff assignments", 
                    "role": "", 
                    "timeline": "1-2 hours before start",
                    "status": "not-started"
                },
                { 
                    "name": "Final Technical Checks", 
                    "description": "Complete final testing of all AV equipment and platforms", 
                    "materials": "Technical checklist, backup equipment, support contacts", 
                    "role": "", 
                    "timeline": "1 hour before start",
                    "status": "not-started"
                },
                { 
                    "name": "Speaker Green Room Management", 
                    "description": "Manage speaker preparation area and final briefings", 
                    "materials": "Green room setup, refreshments, final schedules", 
                    "role": "", 
                    "timeline": "30 minutes before start",
                    "status": "not-started"
                },
                { 
                    "name": "Event Execution & Monitoring", 
                    "description": "Execute event according to timeline and monitor all aspects", 
                    "materials": "Run-of-show document, communication devices, troubleshooting guides", 
                    "role": "", 
                    "timeline": "During event",
                    "status": "not-started"
                },
                { 
                    "name": "Live Social Media Coverage", 
                    "description": "Document event with live social media updates and content", 
                    "materials": "Social media accounts, content templates, photography equipment", 
                    "role": "", 
                    "timeline": "During event",
                    "status": "not-started"
                },
                { 
                    "name": "Event Photography & Recording", 
                    "description": "Capture high-quality photos and recordings for future use", 
                    "materials": "Professional cameras, recording equipment, backup storage", 
                    "role": "", 
                    "timeline": "During event",
                    "status": "not-started"
                }
            ]
        },
        {
            "name": "Post-Event Activities (1-2 weeks after)",
            "children": [
                { 
                    "name": "Immediate Cleanup & Breakdown", 
                    "description": "Clean up venue and pack up all materials and equipment", 
                    "materials": "Cleanup supplies, packing materials, transport arrangements", 
                    "role": "", 
                    "timeline": "Immediately after event",
                    "status": "not-started"
                },
                { 
                    "name": "Feedback Survey Distribution", 
                    "description": "Send detailed feedback surveys to all attendees", 
                    "materials": "Survey platform, question templates, response tracking", 
                    "role": "", 
                    "timeline": "Within 24 hours",
                    "status": "not-started"
                },
                { 
                    "name": "Content Processing & Editing", 
                    "description": "Edit recordings, process photos, and prepare content for distribution", 
                    "materials": "Video editing software, photo editing tools, content templates", 
                    "role": "", 
                    "timeline": "1-3 days after",
                    "status": "not-started"
                },
                { 
                    "name": "Speaker Thank You & Follow-up", 
                    "description": "Send personalized thank you notes and any promised materials to speakers", 
                    "materials": "Thank you templates, speaker contact list, promised deliverables", 
                    "role": "", 
                    "timeline": "1-2 days after",
                    "status": "not-started"
                },
                { 
                    "name": "Financial Reconciliation", 
                    "description": "Process all payments, reconcile expenses, and close out budget", 
                    "materials": "Expense receipts, payment records, budget tracking sheets", 
                    "role": "", 
                    "timeline": "3-5 days after",
                    "status": "not-started"
                },
                { 
                    "name": "Analytics & ROI Analysis", 
                    "description": "Analyze attendance data, engagement metrics, and calculate ROI", 
                    "materials": "Analytics tools, registration data, feedback responses, cost analysis", 
                    "role": "", 
                    "timeline": "1 week after",
                    "status": "not-started"
                },
                { 
                    "name": "Final Report & Documentation", 
                    "description": "Create comprehensive event report with insights and recommendations", 
                    "materials": "Report template, all collected data, photos, learnings documentation", 
                    "role": "", 
                    "timeline": "1-2 weeks after",
                    "status": "not-started"
                },
                { 
                    "name": "Team Debrief & Lessons Learned", 
                    "description": "Conduct team retrospective to capture learnings and improvements", 
                    "materials": "Debrief template, team feedback forms, improvement action items", 
                    "role": "", 
                    "timeline": "1-2 weeks after",
                    "status": "not-started"
                }
            ]
        }
    ]
};

// ---- Helpers: ID assignment and state persistence ----
function generateNodeIds(node, parentId = null) {
    node.id = (parentId ? parentId + "." : "") + (node.name || "root").replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_.]/g, "");
    if (node.children) node.children.forEach(child => generateNodeIds(child, node.id));
}
generateNodeIds(sopData);

function loadSOPState() {
    let state = window.localStorage.getItem("sop_state_professional");
    return state ? JSON.parse(state) : {};
}

function saveSOPState(state) {
    window.localStorage.setItem("sop_state_professional", JSON.stringify(state));
}

let sopState = loadSOPState();

// --- D3 rendering with responsive design ---
let treeWidth, treeHeight, svg, zoomBehavior, svgContainer;

function initializeResponsiveTree() {
    // Calculate responsive dimensions
    const container = document.getElementById('tree-container');
    const containerRect = container.getBoundingClientRect();
    const isMobile = window.innerWidth < 768;
    const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024;
    
    // Set responsive dimensions
    if (isMobile) {
        treeWidth = Math.max(window.innerWidth - 40, 350);
        treeHeight = Math.max(window.innerHeight - 200, 400);
        container.style.width = '95vw';
        container.style.height = `${Math.min(treeHeight, window.innerHeight - 160)}px`;
    } else if (isTablet) {
        treeWidth = Math.max(window.innerWidth - 80, 700);
        treeHeight = Math.max(window.innerHeight - 200, 600);
        container.style.width = '90vw';
        container.style.height = `${Math.min(treeHeight, window.innerHeight - 120)}px`;
    } else {
        treeWidth = 1060;
        treeHeight = 780;
        container.style.width = '1100px';
        container.style.height = '800px';
    }

    // Clear any existing SVG
    d3.select("#tree-container").selectAll("*").remove();
    
    // Create responsive SVG with zoom capabilities
    svgContainer = d3.select("#tree-container")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("viewBox", `0 0 ${treeWidth} ${treeHeight}`)
        .attr("preserveAspectRatio", "xMidYMid meet")
        .style("background", "transparent");
    
    // Add zoom behavior
    zoomBehavior = d3.zoom()
        .scaleExtent([0.2, 3])
        .on("zoom", function(event) {
            svg.attr("transform", event.transform);
        });
    
    svgContainer.call(zoomBehavior);
    
    // Create main SVG group
    svg = svgContainer.append("g");
    
    // Set initial transform with proper centering
    const initialScale = isMobile ? 0.7 : isTablet ? 0.8 : 1;
    const centerX = treeWidth * 0.1;
    const centerY = treeHeight * 0.05;
    
    const initialTransform = d3.zoomIdentity
        .translate(centerX, centerY)
        .scale(initialScale);
    
    svgContainer.call(zoomBehavior.transform, initialTransform);
    
    // Add zoom controls for mobile/tablet
    if (isMobile || isTablet) {
        addZoomControls();
    }
}

function addZoomControls() {
    const controls = d3.select("#tree-container")
        .append("div")
        .attr("class", "zoom-controls")
        .style("position", "absolute")
        .style("top", "10px")
        .style("right", "10px")
        .style("z-index", "1000")
        .style("display", "flex")
        .style("flex-direction", "column")
        .style("gap", "8px");
    
    // Zoom in button
    controls.append("button")
        .attr("class", "zoom-btn zoom-in")
        .style("background", "var(--bg-secondary)")
        .style("border", "1px solid var(--border-primary)")
        .style("border-radius", "8px")
        .style("width", "40px")
        .style("height", "40px")
        .style("color", "var(--text-primary)")
        .style("cursor", "pointer")
        .style("display", "flex")
        .style("align-items", "center")
        .style("justify-content", "center")
        .style("box-shadow", "var(--shadow-lg)")
        .html("➕")
        .on("click", function() {
            svgContainer.transition().duration(200).call(
                zoomBehavior.scaleBy, 1.5
            );
        });
    
    // Zoom out button
    controls.append("button")
        .attr("class", "zoom-btn zoom-out")
        .style("background", "var(--bg-secondary)")
        .style("border", "1px solid var(--border-primary)")
        .style("border-radius", "8px")
        .style("width", "40px")
        .style("height", "40px")
        .style("color", "var(--text-primary)")
        .style("cursor", "pointer")
        .style("display", "flex")
        .style("align-items", "center")
        .style("justify-content", "center")
        .style("box-shadow", "var(--shadow-lg)")
        .html("➖")
        .on("click", function() {
            svgContainer.transition().duration(200).call(
                zoomBehavior.scaleBy, 0.67
            );
        });
    
    // Reset zoom button
    controls.append("button")
        .attr("class", "zoom-btn zoom-reset")
        .style("background", "var(--bg-secondary)")
        .style("border", "1px solid var(--border-primary)")
        .style("border-radius", "8px")
        .style("width", "40px")
        .style("height", "40px")
        .style("color", "var(--text-primary)")
        .style("cursor", "pointer")
        .style("display", "flex")
        .style("align-items", "center")
        .style("justify-content", "center")
        .style("box-shadow", "var(--shadow-lg)")
        .html("🏠")
        .on("click", function() {
            const isMobile = window.innerWidth < 768;
            const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024;
            const initialScale = isMobile ? 0.7 : isTablet ? 0.8 : 1;
            const centerX = treeWidth * 0.1;
            const centerY = treeHeight * 0.05;
            
            const resetTransform = d3.zoomIdentity
                .translate(centerX, centerY)
                .scale(initialScale);
            
            svgContainer.transition().duration(500).call(
                zoomBehavior.transform, resetTransform
            );
        });
}

// Initialize responsive tree
initializeResponsiveTree();

let duration = 500;
let root = d3.hierarchy(sopData, d => d.children);

// Set responsive initial positioning
const isMobile = window.innerWidth < 768;
root.x0 = treeHeight / 2;
root.y0 = 0;
root.children.forEach(collapse);

let selectedNode = null;

update(root);

function collapse(d) {
    if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

function update(source) {
    const isMobile = window.innerWidth < 768;
    const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024;
    
    // Adjust tree layout based on screen size
    const horizontalSpacing = isMobile ? 180 : isTablet ? 200 : 240;
    const verticalSize = isMobile ? treeHeight - 100 : treeHeight - 60;
    const horizontalSize = isMobile ? treeWidth - 150 : treeWidth - 300;
    
    const tree = d3.tree().size([verticalSize, horizontalSize]);
    tree(root);
    const nodes = root.descendants();
    const links = root.links();
    
    // Dynamic spacing based on screen size and tree depth
    nodes.forEach(d => { 
        d.y = d.depth * horizontalSpacing; 
    });
    
    // Enhanced collision detection for mobile
    adjustForCollisions(nodes, isMobile);
    
    let node = svg.selectAll('g.node')
        .data(nodes, d => d.data.id);

    node.exit().transition().duration(duration)
        .attr("transform", d => `translate(${source.y},${source.x})`)
        .style("opacity", 0)
        .remove();

    let nodeEnter = node.enter().append('g')
        .attr('class', d => {
            let classes = `node depth-${d.depth}`;
            if (getTaskState(d.data.id).done) classes += " done";
            if (getTaskState(d.data.id).status === 'in-progress') classes += " in-progress";
            if (selectedNode && d.data.id === selectedNode.data.id) classes += " selected";
            if (d.children) classes += " expanded has-children";
            else if (d._children) classes += " collapsed has-children";
            return classes;
        })
        .attr("transform", d => `translate(${source.y0},${source.x0})`)
        .style("opacity", 0)
        .on('click', (event, d) => {
            event.stopPropagation();
            if (d.children) {
                d._children = d.children;
                d.children = null;
                selectedNode = null;
                hideSidebar();
            } else if (d._children) {
                // Enhanced auto-collapse for mobile
                if (shouldAutoCollapse(d, isMobile)) {
                    if (d.parent) {
                        d.parent.children.forEach(sibling => {
                            if (sibling !== d && sibling.children) {
                                sibling._children = sibling.children;
                                sibling.children = null;
                            }
                        });
                    }
                }
                d.children = d._children;
                d._children = null;
                selectedNode = null;
                hideSidebar();
            } else {
                selectedNode = d;
                showSidebar(d);
            }
            update(d);
        });

    // Responsive node sizing
    const nodeWidth = isMobile ? 160 : isTablet ? 170 : 180;
    const nodeHeight = isMobile ? 45 : 50;
    const fontSize = isMobile ? 11 : 12;
    const iconSize = isMobile ? 6 : 8;

    // Node card with responsive sizing and hierarchical coloring
    nodeEnter.append("rect")
        .attr("class", "node-card")
        .attr("rx", isMobile ? 8 : 12)
        .attr("ry", isMobile ? 8 : 12)
        .attr("x", -nodeWidth/2)
        .attr("y", -nodeHeight/2)
        .attr("width", nodeWidth)
        .attr("height", nodeHeight)
        .style("position", "relative"); // Enable pseudo-elements for expand/collapse indicators

    // Responsive task icon positioning with hierarchical color awareness
    const iconX = -nodeWidth/2 + 15;
    const iconY = isMobile ? -2 : -5;
    
    nodeEnter.append("circle")
        .attr("cx", iconX)
        .attr("cy", iconY)
        .attr("r", iconSize)
        .attr("fill", "rgba(255, 255, 255, 0.9)")
        .attr("stroke", "rgba(255, 255, 255, 0.3)")
        .attr("stroke-width", 1);

    // Enhanced check mark with better visibility
    const checkSize = isMobile ? 1.5 : 2;
    nodeEnter.append("path")
        .attr("d", `M${iconX-3},${iconY-1} L${iconX-1},${iconY+1} L${iconX+3},${iconY-3}`)
        .attr("stroke", d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return "#10b981";
            if (status === 'in-progress') return "#f59e0b";
            return "rgba(99, 102, 241, 0.8)";
        })
        .attr("stroke-width", checkSize)
        .attr("fill", "none")
        .attr("stroke-linecap", "round")
        .attr("stroke-linejoin", "round")
        .style("opacity", d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return 1;
            if (status === 'in-progress') return 0.8;
            return 0.6;
        });

    // Responsive node text
    const textGroups = nodeEnter.append('g')
        .attr('class', 'node-text');

    textGroups.each(function(d) {
        const textGroup = d3.select(this);
        const words = d.data.name.split(/\s+/);
        const lineHeight = isMobile ? 12 : 14;
        const maxWidth = nodeWidth - 40;
        const maxLines = 2;
        const textStartX = -nodeWidth/2 + 30;
        
        let line = [];
        let lineNumber = 0;
        let tspan = textGroup.append("text")
            .attr("x", textStartX)
            .attr("y", isMobile ? -8 : -10)
            .attr('text-anchor', "start")
            .attr('font-size', fontSize)
            .attr('font-weight', 600)
            .attr('fill', "rgba(255, 255, 255, 0.95)")
            .style("text-shadow", "0 1px 2px rgba(0, 0, 0, 0.5)") // Enhanced readability
        
        words.forEach((word, i) => {
            line.push(word);
            tspan.text(line.join(" "));
            
            if (tspan.node().getComputedTextLength() > maxWidth && line.length > 1) {
                line.pop();
                tspan.text(line.join(" "));
                lineNumber++;
                
                if (lineNumber < maxLines && i < words.length - 1) {
                    line = [word];
                    tspan = textGroup.append("text")
                        .attr("x", textStartX)
                        .attr("y", (isMobile ? -8 : -10) + (lineNumber * lineHeight))
                        .attr('text-anchor', "start")
                        .attr('font-size', fontSize)
                        .attr('font-weight', 600)
                        .attr('fill', d => {
                            const state = getTaskState(d.data.id);
                            const status = state.status || d.data.status || 'not-started';
                            if (status === 'completed' || state.done) return "#ffffff";
                            return "#f9fafb";
                        })
                        .text(word);
                } else if (lineNumber >= maxLines) {
                    const currentText = tspan.text();
                    const maxLength = isMobile ? 12 : 15;
                    if (currentText.length > maxLength) {
                        tspan.text(currentText.substring(0, maxLength) + "...");
                    }
                    return;
                }
            }
        });
    });

    let nodeUpdate = nodeEnter.merge(node);
    
    nodeUpdate.transition()
        .duration(duration)
        .attr("transform", d => `translate(${d.y},${d.x})`)
        .style("opacity", 1);

    nodeUpdate
        .attr('class', d => {
            let classes = `node depth-${d.depth}`;
            if (getTaskState(d.data.id).done) classes += " done";
            if (getTaskState(d.data.id).status === 'in-progress') classes += " in-progress";
            if (selectedNode && d.data.id === selectedNode.data.id) classes += " selected";
            if (d.children) classes += " expanded has-children";
            else if (d._children) classes += " collapsed has-children";
            return classes;
        });

    // Update node colors based on state
    nodeUpdate.select("rect")
        .transition()
        .duration(300)
        .attr("fill", d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return "#10b981";
            if (status === 'in-progress') return "#f59e0b";
            return "#374151";
        })
        .attr("stroke", d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return "#10b981";
            if (status === 'in-progress') return "#f59e0b";
            return "#6b7280";
        });

    nodeUpdate.select("circle")
        .transition()
        .duration(300)
        .attr("fill", d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return "#ffffff";
            if (status === 'in-progress') return "#ffffff";
            return "#6366f1";
        });

    nodeUpdate.select("path")
        .transition()
        .duration(300)
        .attr("stroke", d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return "#10b981";
            if (status === 'in-progress') return "#f59e0b";
            return "#ffffff";
        })
        .style("opacity", d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return 1;
            if (status === 'in-progress') return 0.8;
            return 0.5;
        });

    nodeUpdate.selectAll(".node-text text")
        .transition()
        .duration(300)
        .attr('fill', d => {
            const state = getTaskState(d.data.id);
            const status = state.status || d.data.status || 'not-started';
            if (status === 'completed' || state.done) return "#ffffff";
            return "#f9fafb";
        });

    // -------- LINKS with hierarchical coloring ---------
    let link = svg.selectAll('path.link')
        .data(links, d => d.target.data.id);
    
    link.exit().transition()
        .duration(duration)
        .attr('d', d => {
            let o = { x: source.x, y: source.y };
            return diagonal({ source: o, target: o });
        })
        .style("opacity", 0)
        .remove();
    
    link.enter().insert('path', "g")
        .attr('class', d => `link link-path link-depth-${d.target.depth - 1}`)
        .attr('d', d => {
            let o = { x: source.x0, y: source.y0 };
            return diagonal({ source: o, target: o });
        })
        .style("opacity", 0)
        .style("fill", "none")
        .merge(link)
        .transition()
        .duration(duration)
        .attr('d', diagonal)
        .attr('class', d => `link link-path link-depth-${d.target.depth - 1}`); // Apply depth class for coloring
    
    nodes.forEach(d => {
        d.x0 = d.x;
        d.y0 = d.y;
    });
}

function diagonal(d) {
    return `M${d.source.y},${d.source.x}C${d.source.y + 60},${d.source.x} ${d.target.y - 60},${d.target.x} ${d.target.y},${d.target.x}`;
}

// Enhanced collision detection with mobile considerations
function adjustForCollisions(nodes, isMobile = false) {
    const NODE_HEIGHT = isMobile ? 55 : 60;
    const MIN_SPACING = isMobile ? 5 : 10;
    
    const nodesByLevel = d3.group(nodes, d => d.depth);
    
    nodesByLevel.forEach((levelNodes, depth) => {
        if (levelNodes.length <= 1) return;
        
        levelNodes.sort((a, b) => a.x - b.x);
        
        for (let i = 1; i < levelNodes.length; i++) {
            const currentNode = levelNodes[i];
            const prevNode = levelNodes[i - 1];
            
            const minDistance = NODE_HEIGHT + MIN_SPACING;
            const currentDistance = currentNode.x - prevNode.x;
            
            if (currentDistance < minDistance) {
                const adjustment = minDistance - currentDistance;
                for (let j = i; j < levelNodes.length; j++) {
                    levelNodes[j].x += adjustment;
                }
            }
        }
    });
}

// Enhanced auto-collapse with mobile considerations
function shouldAutoCollapse(node, isMobile = false) {
    if (!node.children || node.children.length === 0) return false;
    
    const visibleDescendants = countVisibleDescendants(node);
    const availableHeight = treeHeight - (isMobile ? 120 : 80);
    const nodeHeight = isMobile ? 60 : 70;
    const requiredHeight = visibleDescendants * nodeHeight;
    
    // More aggressive auto-collapse on mobile
    const threshold = isMobile ? 0.7 : 0.8;
    return requiredHeight > (availableHeight * threshold);
}

function countVisibleDescendants(node) {
    if (!node.children) return 0;
    
    let count = node.children.length;
    node.children.forEach(child => {
        if (child.children) {
            count += countVisibleDescendants(child);
        }
    });
    return count;
}

// ---- Sidebar with improved design ----
function showSidebar(d) {
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('sidebar-content');
    let state = getTaskState(d.data.id);
    let isLeaf = !(d.children || d._children);
    
    // Determine status display
    const statusOptions = [
        { value: 'not-started', label: 'Not Started', color: 'bg-gray-500' },
        { value: 'in-progress', label: 'In Progress', color: 'bg-yellow-500' },
        { value: 'completed', label: 'Completed', color: 'bg-green-500' }
    ];
    
    const currentStatus = state.status || d.data.status || 'not-started';
    
    // Email details section for email-related tasks
    const emailDetailsSection = d.data.emailDetails ? `
        <div>
            <div class="section-title flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
                Email Details
            </div>
            <div class="bg-gray-800 rounded-lg p-4 space-y-3">
                <div>
                    <span class="text-sm font-medium text-gray-400">Subject Line:</span>
                    <p class="text-gray-200 text-sm mt-1">${d.data.emailDetails.subject}</p>
                </div>
                <div>
                    <span class="text-sm font-medium text-gray-400">Content Focus:</span>
                    <p class="text-gray-200 text-sm mt-1">${d.data.emailDetails.content}</p>
                </div>
                <div>
                    <span class="text-sm font-medium text-gray-400">Target Audience:</span>
                    <p class="text-gray-200 text-sm mt-1">${d.data.emailDetails.audience}</p>
                </div>
            </div>
        </div>
    ` : '';
    
    content.innerHTML = `
        <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-600">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 12l2 2 4-4"/>
                </svg>
            </div>
            <div>
                <h2 class="text-xl font-bold text-white">${d.data.name}</h2>
                <p class="text-sm text-gray-400">Task Details</p>
            </div>
        </div>
        
        <div class="space-y-6">
            <div>
                <div class="section-title">Task Status</div>
                <select id="status-select" class="input-field">
                    ${statusOptions.map(option => 
                        `<option value="${option.value}" ${currentStatus === option.value ? 'selected' : ''}>${option.label}</option>`
                    ).join('')}
                </select>
            </div>
            
            ${d.data.timeline ? `
            <div>
                <div class="section-title flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    Timeline
                </div>
                <div class="bg-indigo-900/30 border border-indigo-600/30 rounded-lg p-3">
                    <p class="text-indigo-200 font-medium">${d.data.timeline}</p>
                </div>
            </div>
            ` : ''}
            
            <div>
                <div class="section-title">Description</div>
                <p class="text-gray-200 leading-relaxed">${d.data.description || "No description provided"}</p>
            </div>
            
            <div>
                <div class="section-title">Materials & Requirements</div>
                <p class="text-gray-300 leading-relaxed">${d.data.materials || "No specific materials required"}</p>
            </div>
            
            ${emailDetailsSection}
            
            <div>
                <div class="section-title flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Assigned Owner
                </div>
                <input type="text" 
                       id="owner-input" 
                       value="${state.owner || ""}"
                       class="input-field"
                       placeholder="Assign team member or role">
            </div>
            
            <div>
                <div class="section-title">Notes</div>
                <textarea id="notes-input" 
                         class="input-field h-20 resize-none" 
                         placeholder="Add notes or additional details...">${state.notes || ""}</textarea>
            </div>
        </div>
        
        <div class="flex gap-3 mt-8 pt-6 border-t border-gray-600">
            ${d.parent ? `<button class="btn btn-secondary flex-1" id="parent-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Go to Parent
            </button>` : ""}
            ${isLeaf ? `<button class="btn btn-danger" id="delete-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
                Delete
            </button>` : ""}
        </div>
    `;
    
    sidebar.classList.remove("hidden");
    sidebar.classList.add("flex");
    document.getElementById('fade-bg').classList.remove("hidden");
    
    // Event listeners
    document.getElementById('status-select').onchange = function() {
        const status = this.value;
        setTaskState(d.data.id, { 
            status: status, 
            done: status === 'completed' 
        });
        update(d);
    };
    
    document.getElementById('owner-input').onchange = function() {
        setTaskState(d.data.id, { owner: this.value });
    };
    
    document.getElementById('notes-input').onchange = function() {
        setTaskState(d.data.id, { notes: this.value });
    };
    
    if (isLeaf && document.getElementById('delete-btn')) {
        document.getElementById('delete-btn').onclick = function() {
            if (confirm('Are you sure you want to delete this task?')) {
                deleteLeafNode(d);
                hideSidebar();
            }
        };
    }
    
    if (d.parent && document.getElementById('parent-btn')) {
        document.getElementById('parent-btn').onclick = function() {
            selectedNode = d.parent;
            showSidebar(d.parent);
            update(d.parent);
        }
    }
}

function hideSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.add("hidden");
    sidebar.classList.remove("flex");
    document.getElementById('fade-bg').classList.add("hidden");
    selectedNode = null;
    update(root);
}

document.getElementById('fade-bg').onclick = hideSidebar;

function getTaskState(id) {
    if (!sopState[id]) {
        sopState[id] = { 
            done: false, 
            owner: "", 
            status: "not-started",
            notes: ""
        };
    }
    return sopState[id];
}

function setTaskState(id, changes) {
    sopState[id] = Object.assign({}, getTaskState(id), changes);
    saveSOPState(sopState);
}

function deleteLeafNode(d) {
    if (!d.parent) return;
    let idx = d.parent.data.children.findIndex(child => child.id === d.data.id);
    if (idx > -1) d.parent.data.children.splice(idx, 1);
    update(d.parent);
}

// Close sidebar with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideSidebar();
    }
});

// Enhanced responsive handling
let resizeTimeout;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
        initializeResponsiveTree();
        update(root);
    }, 250);
});

// Enhanced mobile touch handling
if ('ontouchstart' in window) {
    // Prevent double-tap zoom on mobile
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // Add touch-friendly interaction hints
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('tree-container');
        if (container && window.innerWidth < 768) {
            container.style.touchAction = 'manipulation';
        }
    });
}

window.onload = function() {
    const container = document.getElementById('tree-container');
    if (container) {
        container.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center', 
            inline: 'center' 
        });
    }
};
</script>
</body>
</html>
